# PR代码审查工具

这是一个简单的PR代码审查工具，用于自动分析PR中的代码变更并提供审查建议。通过集成AI服务，它可以提供更详细和智能的代码审查结果。

## 流程图

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  获取PR变更内容  │────▶│  分析代码变更    │────▶│ 生成审查报告    │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│ GitHub API 调用 │     │ 模拟分析 或 AI  │     │  提交评论到PR   │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 功能

- 获取PR的差异内容（添加、删除、修改的代码）
- 分析代码变更（支持模拟分析和AI分析）
- 生成审查报告（包含问题列表和总结）
- 提交审查结果到PR评论

## 技术架构

工具由以下主要组件构成：

- **GitHub 客户端**: 负责与GitHub API交互，获取PR信息和提交评论
- **代码分析器**: 分析代码变更，生成审查结果
  - 模拟分析器: 提供预设的审查结果（用于测试）
  - AI分析器: 使用第三方AI服务进行智能代码审查
- **报告生成器**: 将审查结果格式化为PR评论

## 安装

```bash
# 安装依赖
npm install
```

## 配置

1. 复制环境变量示例文件并修改
```bash
cp .env.example .env
```

2. 编辑`.env`文件，填入必要的配置信息:
   - `PERSONAL_TOKEN`: GitHub个人访问令牌
   - `GITHUB_OWNER`: GitHub仓库所有者
   - `GITHUB_REPO`: GitHub仓库名称
   - `PR_NUMBER`: 要审查的PR编号
   - `LOG_LEVEL`: 日志级别(debug, info, warn, error)
   - `DRY_RUN`: 是否为干运行模式(true/false)
   - `AI_API_KEY`: AI服务的API密钥（可选，用于AI分析）
   - `AI_API_ENDPOINT`: AI服务的API端点（可选，默认为OpenAI）
   - `AI_MODEL`: 使用的AI模型（可选，默认为gpt-4）

## 使用

```bash
# 构建项目
npm run build

# 运行审查工具
npm start

# 开发模式运行
npm run dev
```

## 运行模式

工具支持以下运行模式：

- **正常模式**: 获取真实PR差异并进行分析
  - 可以选择使用模拟分析器或AI分析器
  - 根据是否配置AI_API_KEY自动选择分析器

- **干运行模式**: 只分析不提交评论到GitHub
  - 设置`DRY_RUN=true`启用

## AI集成

工具支持使用AI进行高质量的代码审查，目前已集成OpenAI API。

### 配置AI服务

要使用AI进行代码审查，需要:

1. 获取OpenAI API密钥
   - 访问 [OpenAI平台](https://platform.openai.com/)
   - 创建账户并获取API密钥
   - 确保账户中有足够的使用额度

2. 在`.env`文件中设置配置项:
   ```
   # 启用AI分析需要设置此项
   AI_API_KEY=your_openai_api_key_here
   
   # 可选：自定义API端点，默认为OpenAI端点
   AI_API_ENDPOINT=https://api.openai.com/v1/chat/completions
   
   # 可选：指定模型，默认为GPT-4
   AI_MODEL=gpt-4
   ```

3. 运行程序时将自动检测是否配置了AI_API_KEY，并相应选择分析器:
   ```bash
   npm run dev
   ```

### AI审查流程

使用AI进行代码审查的流程如下:

1. 系统获取PR的差异内容
2. 将差异内容格式化为适合AI分析的提示
3. 调用AI服务进行分析
4. 解析AI的回复为结构化的审查结果
5. 生成审查报告和具体的评论

### AI审查质量

AI代码审查特别关注以下方面:

- **代码质量**: 可读性、可维护性、命名规范
- **架构设计**: 模块化、职责分离、依赖关系
- **性能问题**: 算法效率、资源使用、性能瓶颈
- **安全隐患**: 潜在漏洞、输入验证、敏感数据处理
- **最佳实践**: 行业标准、设计模式
- **潜在bug**: 逻辑错误、边界情况、异常处理
- **代码重复**: 重构机会

### 自定义AI提示

高级用户可以通过修改`src/analyzer/aiAnalyzer.ts`文件中的`preparePromptFromDiffs`方法来自定义AI提示，以便获得更符合特定项目需求的审查结果。

## 扩展

目前已经搭建了基本框架，可以根据需要扩展更高级的功能：

- 集成更多类型的代码分析工具
- 添加更丰富的报告格式
- 实现多种评论发布策略
- 支持更多代码质量指标 